<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Console</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e14;--bg2:#111621;--bg3:#1a202c;--border:#1e2533;--text:#cbd5e0;--text2:#4a5568;--text3:#718096;--white:#e2e8f0;--blue:#63b3ed;--green:#48bb78;--red:#fc8181;--orange:#ed8936;--blue2:#2b6cb0}
body{font-family:'DM Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom: 80px;}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#2d3748;border-radius:3px}
button, select{cursor:pointer;font-family:'Outfit',sans-serif;transition:filter .15s}button:hover{filter:brightness(1.15)}
input, select{font-family:inherit;outline:none}

.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.logo-area{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#2b6cb0,#63b3ed);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff}
.title{font-size:20px;font-weight:800;color:var(--white);letter-spacing:2px;font-family:'Outfit',sans-serif}
.controls{display:flex;gap:10px;align-items:center}

.btn-pri{padding:8px 16px;background:linear-gradient(135deg,#2b6cb0,#3182ce);border:none;color:#fff;border-radius:6px;font-size:13px;font-weight:600}
.btn-sec{padding:8px 16px;background:var(--bg2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:13px;font-weight:600}
.btn-sec.active{background:var(--blue2);color:white;border-color:var(--blue2)}

.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:24px}
.metric-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:20px}
.metric-title{font-family:'Outfit',sans-serif;font-size:13px;color:var(--text3);margin-bottom:8px}
.metric-val{font-size:24px;font-weight:500;color:var(--white)}

.table-container{background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow-x:auto}
table{width:100%;border-collapse:collapse;text-align:left}
th{font-family:'Outfit',sans-serif;font-size:12px;color:var(--text3);font-weight:600;padding:16px;border-bottom:1px solid var(--border);background:var(--bg3);cursor:pointer;user-select:none;}
th:hover{color:var(--white)}
td{padding:16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text)}
.positive{color:var(--green);font-weight:500}
.negative{color:var(--red);font-weight:500}

.tab-container{display:flex;gap:10px;margin-bottom:16px}
#settingsPanel{display:none;background:var(--bg2);padding:16px;border-radius:8px;border:1px solid var(--border);margin-bottom:24px;gap:12px;align-items:flex-end}

.terminal-wrapper{background:#000;border:1px solid #333;border-radius:8px;margin-top:24px;overflow:hidden;}
.terminal-header{background:#111;padding:8px 16px;font-family:'Outfit';font-size:12px;color:#888;display:flex;justify-content:space-between;cursor:pointer;}
.terminal-body{padding:16px;height:200px;overflow-y:auto;font-family:'DM Mono';font-size:12px;color:#4af626;line-height:1.6;}
.log-line{margin-bottom:4px;}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo">‚ö°</div>
            <div class="title">TRADE CONSOLE</div>
        </div>
        <div class="controls">
            <select id="brokerFilter" class="btn-sec" onchange="renderUI()">
                <option value="ALL">All Brokers</option>
            </select>
            <select id="segFilter" class="btn-sec" onchange="renderUI()">
                <option value="ALL">All Segments</option>
                <option value="EQ">Equity</option>
                <option value="F&O">F&O</option>
                <option value="MCX">Commodity</option>
            </select>

            <button class="btn-sec" style="color:var(--red);border-color:var(--red)" onclick="clearLedger()">üóëÔ∏è Clear Ledger</button>
            <input type="file" id="csvUpload" multiple accept=".csv" style="display:none" onchange="handleFileUpload(event)">
            <button class="btn-sec" onclick="document.getElementById('csvUpload').click()">üìÅ Upload CSV</button>
            <button class="btn-sec" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <button class="btn-pri" onclick="fetchPortfolio()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="settingsPanel">
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3)">Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy..." style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3)">Backend URL</label>
            <input type="text" id="backendUrl" placeholder="https://..." style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <button class="btn-pri" onclick="saveSettings()">Save</button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title" id="lblPnl">NET P&L</div>
            <div class="metric-val" id="valPnl">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title" id="lblInv">INVESTED CAPITAL</div>
            <div class="metric-val" id="valInv">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title" id="lblPos">TRADES / POSITIONS</div>
            <div class="metric-val" id="valPos">0</div>
        </div>
    </div>

    <div class="tab-container">
        <button id="tab-active" class="btn-sec active" onclick="setTab('active')">ACTIVE POSITIONS</button>
        <button id="tab-closed" class="btn-sec" onclick="setTab('closed')">CLOSED HISTORY</button>
    </div>

    <div class="table-container">
        <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody">
                <tr><td colspan="10" style="text-align:center">No data loaded.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="terminal-wrapper">
        <div class="terminal-header" onclick="toggleTerminal()">
            <span>>_ SYSTEM LOGS</span>
            <span id="termToggleBtn">‚ñº</span>
        </div>
        <div class="terminal-body" id="terminalBody">
            <div class="log-line">System initialized. Awaiting commands...</div>
        </div>
    </div>
</div>

<script>
let state = {
    open: [], closed: [], currentTab: 'active',
    sortCol: 'Symbol', sortAsc: true, fetchingPrices: false, isPollingLogs: false,
    apiKey: localStorage.getItem('tc_gemini_key') || '',
    backendUrl: localStorage.getItem('tc_backend_url') || 'http://localhost:8000'
};

document.getElementById('geminiKey').value = state.apiKey;
document.getElementById('backendUrl').value = state.backendUrl;

const DB_NAME = "TradeConsoleDB";
const STORE_NAME = "csvFiles";

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => { e.target.result.createObjectStore(STORE_NAME); };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject("IndexedDB error");
    });
}

async function saveFileToBrowser(filename, textContent) {
    const db = await initDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(textContent, filename);
        tx.oncomplete = resolve;
    });
}

async function loadFilesFromBrowser() {
    const db = await initDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        const keysReq = store.getAllKeys();
        req.onsuccess = () => {
            keysReq.onsuccess = () => {
                const files = [];
                for(let i=0; i<req.result.length; i++) {
                    files.push({ filename: keysReq.result[i], content: req.result[i] });
                }
                resolve(files);
            };
        };
    });
}

async function clearBrowserFiles() {
    const db = await initDB();
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).clear();
        tx.oncomplete = resolve;
    });
}

function toggleSettings() {
    const p = document.getElementById('settingsPanel');
    p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
}
function saveSettings() {
    state.apiKey = document.getElementById('geminiKey').value;
    state.backendUrl = document.getElementById('backendUrl').value;
    localStorage.setItem('tc_gemini_key', state.apiKey);
    localStorage.setItem('tc_backend_url', state.backendUrl);
    toggleSettings();
}
function setTab(tab) {
    state.currentTab = tab;
    document.getElementById('tab-active').classList.toggle('active', tab === 'active');
    document.getElementById('tab-closed').classList.toggle('active', tab === 'closed');
    renderUI();
}
function handleSort(col) {
    if (state.sortCol === col) state.sortAsc = !state.sortAsc;
    else { state.sortCol = col; state.sortAsc = true; }
    renderUI();
}
function toggleTerminal() {
    const body = document.getElementById('terminalBody');
    const btn = document.getElementById('termToggleBtn');
    if(body.style.display === 'none') { body.style.display = 'block'; btn.innerText = '‚ñº'; } 
    else { body.style.display = 'none'; btn.innerText = '‚ñ≤'; }
}
function appendLog(text) {
    const tb = document.getElementById('terminalBody');
    tb.innerHTML += `<div class="log-line">${text}</div>`;
    tb.scrollTop = tb.scrollHeight;
}
async function pollLogs() {
    if(!state.isPollingLogs) return;
    try {
        const res = await fetch(`${state.backendUrl}/api/logs`);
        if(res.ok) {
            const data = await res.json();
            data.logs.forEach(log => appendLog(log));
        }
    } catch(e){}
    setTimeout(pollLogs, 500);
}
function startLogPolling() {
    if(!state.isPollingLogs) { state.isPollingLogs = true; pollLogs(); }
}
function stopLogPolling() {
    setTimeout(() => { state.isPollingLogs = false; }, 2000);
}

const fmtMoney = (num) => "‚Çπ" + num.toLocaleString('en-IN', {minimumFractionDigits:0, maximumFractionDigits:0});
const fmtDec = (num) => Number(num).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

async function clearLedger() {
    if(!confirm("Permanently delete all data from Cloud and Browser?")) return;
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" style="text-align:center">Clearing Ledger...</td></tr>`;
    startLogPolling();
    try {
        await fetch(`${state.backendUrl}/api/clear`, { method: 'DELETE' });
        await clearBrowserFiles();
        state.open = []; state.closed = [];
        renderUI();
    } catch(e) { alert("Failed to clear data."); }
    stopLogPolling();
}

async function handleFileUpload(event) {
    const files = event.target.files;
    if(!files.length) return;
    
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" style="text-align:center">Saving to Browser & Cloud...</td></tr>`;
    startLogPolling();
    
    for(let f of files) {
        const text = await f.text();
        await saveFileToBrowser(f.name, text);
    }
    
    const formData = new FormData();
    for(let f of files) formData.append("files", f);
    
    try {
        const res = await fetch(`${state.backendUrl}/api/upload`, { method: 'POST', body: formData });
        if(res.ok) fetchPortfolio();
    } catch(e) { alert("Backend upload failed."); }
}

async function fetchPortfolio() {
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" style="text-align:center">Calculating Positions...</td></tr>`;
    startLogPolling();
    try {
        const res = await fetch(`${state.backendUrl}/api/portfolio`);
        if(!res.ok) throw new Error();
        const data = await res.json();
        
        if (data.positions.open.length === 0 && data.positions.closed.length === 0) {
            const localFiles = await loadFilesFromBrowser();
            if (localFiles.length > 0) {
                appendLog("Cloud reset detected. Restoring files from browser memory...");
                await fetch(`${state.backendUrl}/api/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(localFiles)
                });
                return fetchPortfolio();
            }
        }
        
        state.open = data.positions.open || [];
        state.closed = data.positions.closed || [];
        populateBrokerDropdown();
        renderUI(); 
        
        if (state.open.length > 0 && data.positions.token_map && Object.keys(data.positions.token_map).length > 0) {
            fetchLivePrices(data.positions.token_map);
        } else {
            stopLogPolling();
        }
    } catch(e) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="10" style="text-align:center;color:var(--red)">Failed to load data.</td></tr>`;
        stopLogPolling();
    }
}

async function fetchLivePrices(token_map) {
    state.fetchingPrices = true;
    renderUI(); 
    try {
        const res = await fetch(`${state.backendUrl}/api/live_prices`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token_map: token_map })
        });
        
        if (res.ok) {
            const prices = await res.json();
            state.open.forEach(p => {
                const cmp = prices[p.Symbol] || 0;
                if (cmp > 0) {
                    p.CMP = cmp;
                    p["P&L"] = (cmp - p["Avg Price"]) * p.Qty * (p.Direction === 'Long' ? 1 : -1);
                    p["ROI %"] = p.Invested > 0 ? (p["P&L"] / p.Invested) * 100 : 0;
                }
            });
        }
    } catch (e) { console.error(e); } 
    finally {
        state.fetchingPrices = false;
        renderUI(); 
        stopLogPolling();
    }
}

function populateBrokerDropdown() {
    const allBrokers = new Set([...state.open.map(p=>p.Broker), ...state.closed.map(p=>p.Broker)]);
    const select = document.getElementById('brokerFilter');
    const currentVal = select.value;
    select.innerHTML = '<option value="ALL">All Brokers</option>';
    allBrokers.forEach(b => { if(b) select.innerHTML += `<option value="${b}">${b}</option>`; });
    select.value = currentVal;
}

function renderUI() {
    const bFilter = document.getElementById('brokerFilter').value;
    const sFilter = document.getElementById('segFilter').value;
    
    let dataList = [...(state.currentTab === 'active' ? state.open : state.closed)];
    
    if (bFilter !== 'ALL') dataList = dataList.filter(p => p.Broker === bFilter);
    if (sFilter !== 'ALL') dataList = dataList.filter(p => p.Segment === sFilter || (sFilter==='F&O' && p.Segment.includes('FO')));

    dataList.sort((a, b) => {
        let valA = a[state.sortCol] || ''; let valB = b[state.sortCol] || '';
        if(typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
        if (valA < valB) return state.sortAsc ? -1 : 1;
        if (valA > valB) return state.sortAsc ? 1 : -1;
        return 0;
    });

    const thIcon = (col) => state.sortCol === col ? (state.sortAsc ? ' ‚Üë' : ' ‚Üì') : '';
    let totalPnl = 0, totalInv = 0; let html = '';

    if (state.currentTab === 'active') {
        document.getElementById('tableHead').innerHTML = `<tr>
            <th onclick="handleSort('Symbol')">SYMBOL${thIcon('Symbol')}</th>
            <th onclick="handleSort('Broker')">BROKER${thIcon('Broker')}</th>
            <th onclick="handleSort('Segment')">SEG${thIcon('Segment')}</th>
            <th onclick="handleSort('Direction')">DIR${thIcon('Direction')}</th>
            <th onclick="handleSort('Qty')">QTY${thIcon('Qty')}</th>
            <th onclick="handleSort('Avg Price')">AVG PRICE${thIcon('Avg Price')}</th>
            <th onclick="handleSort('Invested')">MARGIN / INVESTED${thIcon('Invested')}</th>
            <th onclick="handleSort('CMP')">CMP${thIcon('CMP')}</th>
            <th onclick="handleSort('P&L')">P&L${thIcon('P&L')}</th>
            <th onclick="handleSort('ROI %')">ROI %${thIcon('ROI %')}</th>
        </tr>`;
        
        document.getElementById('lblPnl').innerHTML = state.fetchingPrices 
            ? 'NET UNREALIZED P&L <span style="color:var(--orange);font-size:10px;margin-left:8px;font-weight:700">fetching live prices ‚è≥...</span>' 
            : 'NET UNREALIZED P&L';
        document.getElementById('lblInv').innerText = 'MARGIN / INVESTED';
        
        dataList.forEach(p => {
            totalPnl += p["P&L"]; totalInv += p.Invested;
            const cls = p["P&L"] > 0 ? 'positive' : p["P&L"] < 0 ? 'negative' : '';
            const sgn = p["P&L"] > 0 ? '+' : '';
            const displayCmp = (state.fetchingPrices && p.CMP === 0) ? '<span style="color:var(--text3)">...</span>' : fmtDec(p.CMP);
            const dirColor = p.Direction === 'Long' ? 'color:var(--green)' : 'color:var(--red)';
            
            html += `<tr>
                <td style="font-weight:600;color:var(--white)">${p.Symbol}</td>
                <td style="color:var(--text3);font-size:12px">${p.Broker}</td>
                <td><span class="btn-sec" style="padding:2px 6px;font-size:10px">${p.Segment}</span></td>
                <td style="font-weight:600;font-size:11px;${dirColor}">${p.Direction.toUpperCase()}</td>
                <td>${p.Qty}</td><td>${fmtDec(p["Avg Price"])}</td><td>${fmtMoney(p.Invested)}</td>
                <td style="color:var(--white)">${displayCmp}</td>
                <td class="${cls}">${sgn}${fmtMoney(p["P&L"])}</td>
                <td class="${cls}">${sgn}${fmtDec(p["ROI %"])}%</td>
            </tr>`;
        });
    } else {
        document.getElementById('tableHead').innerHTML = `<tr>
            <th onclick="handleSort('Symbol')">SYMBOL${thIcon('Symbol')}</th>
            <th onclick="handleSort('Segment')">SEG${thIcon('Segment')}</th>
            <th onclick="handleSort('Direction')">DIR${thIcon('Direction')}</th>
            <th onclick="handleSort('Qty')">QTY${thIcon('Qty')}</th>
            <th onclick="handleSort('Entry Price')">ENTRY${thIcon('Entry Price')}</th>
            <th onclick="handleSort('Exit Price')">EXIT${thIcon('Exit Price')}</th>
            <th onclick="handleSort('P&L')">P&L${thIcon('P&L')}</th>
            <th onclick="handleSort('Exit Date')">DATE${thIcon('Exit Date')}</th>
        </tr>`;
        document.getElementById('lblPnl').innerText = 'REALIZED P&L';
        document.getElementById('lblInv').innerText = 'WIN RATE';
        
        let wins = 0;
        dataList.forEach(p => {
            totalPnl += p["P&L"];
            if(p["P&L"] > 0) wins++;
            const cls = p["P&L"] > 0 ? 'positive' : p["P&L"] < 0 ? 'negative' : '';
            const sgn = p["P&L"] > 0 ? '+' : '';
            const dirColor = p.Direction === 'Long' ? 'color:var(--green)' : 'color:var(--red)';
            
            html += `<tr>
                <td style="font-weight:600;color:var(--white)">${p.Symbol}</td>
                <td><span class="btn-sec" style="padding:2px 6px;font-size:10px">${p.Segment}</span></td>
                <td style="font-weight:600;font-size:11px;${dirColor}">${p.Direction.toUpperCase()}</td>
                <td>${p.Qty}</td><td>${fmtDec(p["Entry Price"])}</td><td>${fmtDec(p["Exit Price"])}</td>
                <td class="${cls}">${sgn}${fmtMoney(p["P&L"])}</td>
                <td>${p["Exit Date"]}</td>
            </tr>`;
        });
        totalInv = dataList.length > 0 ? (wins / dataList.length * 100).toFixed(1) + '%' : '0%';
    }

    if(!dataList.length) html = `<tr><td colspan="10" style="text-align:center">No data found.</td></tr>`;
    document.getElementById('tableBody').innerHTML = html;
    
    const pnlEl = document.getElementById('valPnl');
    pnlEl.innerText = (totalPnl>0?'+':'') + fmtMoney(totalPnl);
    pnlEl.className = 'metric-val ' + (totalPnl > 0 ? 'positive' : totalPnl < 0 ? 'negative' : '');
    
    document.getElementById('valInv').innerText = state.currentTab === 'active' ? fmtMoney(totalInv) : totalInv;
    document.getElementById('valPos').innerText = dataList.length;
}

if(state.backendUrl) fetchPortfolio();
</script>
</body>
</html>
