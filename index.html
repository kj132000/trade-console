<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Console</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e14;--bg2:#111621;--bg3:#1a202c;--border:#1e2533;--text:#cbd5e0;--text2:#4a5568;--text3:#718096;--white:#e2e8f0;--blue:#63b3ed;--green:#48bb78;--red:#fc8181;--orange:#ed8936;--blue2:#2b6cb0}
body{font-family:'DM Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom: 80px;}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#2d3748;border-radius:3px}
button{cursor:pointer;font-family:'Outfit',sans-serif;transition:filter .15s}button:hover{filter:brightness(1.15)}
input{font-family:inherit;outline:none}
input:focus{border-color:var(--blue)!important;box-shadow:0 0 0 2px rgba(99,179,237,.15)}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.logo-area{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#2b6cb0,#63b3ed);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff}
.title{font-size:20px;font-weight:800;color:var(--white);letter-spacing:2px;font-family:'Outfit',sans-serif}
.controls{display:flex;gap:10px;align-items:center}

/* Buttons */
.btn-pri{padding:8px 16px;background:linear-gradient(135deg,#2b6cb0,#3182ce);border:none;color:#fff;border-radius:6px;font-size:13px;font-weight:600}
.btn-sec{padding:8px 16px;background:var(--bg2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:13px;font-weight:600}

/* Metrics */
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:24px}
.metric-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:20px}
.metric-title{font-family:'Outfit',sans-serif;font-size:13px;color:var(--text3);margin-bottom:8px}
.metric-val{font-size:24px;font-weight:500;color:var(--white)}

/* Table */
.table-container{background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow-x:auto}
table{width:100%;border-collapse:collapse;text-align:left}
th{font-family:'Outfit',sans-serif;font-size:12px;color:var(--text3);font-weight:600;padding:16px;border-bottom:1px solid var(--border);background:var(--bg3)}
td{padding:16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text)}
.positive{color:var(--green);font-weight:500}
.negative{color:var(--red);font-weight:500}

/* Chat UI */
.chat-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#2b6cb0,#3182ce);border:none;color:white;font-size:24px;box-shadow:0 4px 12px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100}
.chat-panel{position:fixed;bottom:90px;right:24px;width:380px;height:500px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:none;flex-direction:column;box-shadow:0 8px 24px rgba(0,0,0,0.5);z-index:100;overflow:hidden}
.chat-header{padding:16px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.chat-header h3{font-family:'Outfit',sans-serif;color:var(--white);font-size:15px}
.chat-body{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
.chat-msg{padding:10px 14px;border-radius:8px;font-size:13px;line-height:1.5;max-width:85%}
.chat-msg.user{background:var(--blue2);color:white;align-self:flex-end;border-bottom-right-radius:2px}
.chat-msg.bot{background:var(--bg3);color:var(--text);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:2px}
.chat-input-wrap{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--bg)}
.chat-input-wrap input{flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);color:var(--white);border-radius:6px;font-size:13px}

/* Settings Panel */
#settingsPanel{display:none;background:var(--bg2);padding:16px;border-radius:8px;border:1px solid var(--border);margin-bottom:24px;gap:12px;align-items:flex-end}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo">‚ö°</div>
            <div class="title">TRADE CONSOLE</div>
        </div>
        <div class="controls">
            <input type="file" id="csvUpload" multiple accept=".csv" style="display:none" onchange="handleFileUpload(event)">
            <button class="btn-sec" onclick="document.getElementById('csvUpload').click()">üìÅ Upload CSV</button>
            <button class="btn-sec" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <button class="btn-pri" onclick="fetchPortfolio()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="settingsPanel">
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3);font-family:'Outfit'">Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy..." style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3);font-family:'Outfit'">Backend URL</label>
            <input type="text" id="backendUrl" placeholder="http://localhost:8000" value="http://localhost:8000" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <button class="btn-pri" onclick="saveSettings()">Save</button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title">NET P&L</div>
            <div class="metric-val" id="valPnl">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">INVESTED CAPITAL</div>
            <div class="metric-val" id="valInv">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">ACTIVE POSITIONS</div>
            <div class="metric-val" id="valPos">0</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>SYMBOL</th>
                    <th>SEG</th>
                    <th>DIR</th>
                    <th>QTY</th>
                    <th>AVG PRICE</th>
                    <th>CMP</th>
                    <th>P&L</th>
                    <th>ROI %</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="8" style="text-align:center;color:var(--text3)">No data loaded.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<button class="chat-fab" onclick="toggleChat()">‚ú®</button>
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <h3>‚ú® Gemini AI</h3>
        <button style="background:none;border:none;color:var(--text3);font-size:16px" onclick="toggleChat()">‚úï</button>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-msg bot">Hello! I am connected to your live portfolio. Ask me anything about your positions.</div>
    </div>
    <div class="chat-input-wrap">
        <input type="text" id="chatInput" placeholder="Analyze my portfolio..." onkeypress="if(event.key==='Enter') sendChat()">
        <button class="btn-pri" onclick="sendChat()">Send</button>
    </div>
</div>

<script>
// State Management
let state = {
    positions: [],
    apiKey: localStorage.getItem('tc_gemini_key') || '',
    backendUrl: localStorage.getItem('tc_backend_url') || 'http://localhost:8000',
    chatHistory: []
};

// Initialization
document.getElementById('geminiKey').value = state.apiKey;
document.getElementById('backendUrl').value = state.backendUrl;

function toggleSettings() {
    const p = document.getElementById('settingsPanel');
    p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
}

function saveSettings() {
    state.apiKey = document.getElementById('geminiKey').value;
    state.backendUrl = document.getElementById('backendUrl').value;
    localStorage.setItem('tc_gemini_key', state.apiKey);
    localStorage.setItem('tc_backend_url', state.backendUrl);
    toggleSettings();
}

// Formatters
const fmtMoney = (num) => "‚Çπ" + num.toLocaleString('en-IN', {minimumFractionDigits:0, maximumFractionDigits:0});
const fmtDec = (num) => Number(num).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});

// 1. Backend Communication (The Bridge)
async function handleFileUpload(event) {
    const files = event.target.files;
    if(!files.length) return;
    
    const formData = new FormData();
    for(let f of files) formData.append("files", f);

    document.getElementById('tableBody').innerHTML = `<tr><td colspan="8" style="text-align:center">Uploading to backend...</td></tr>`;
    
    try {
        const res = await fetch(`${state.backendUrl}/api/upload`, {
            method: 'POST',
            body: formData
        });
        if(res.ok) fetchPortfolio();
        else alert("Upload failed.");
    } catch(e) {
        alert("Cannot connect to backend: " + state.backendUrl);
    }
}

async function fetchPortfolio() {
    document.getElementById('tableBody').innerHTML = `<tr><td colspan="8" style="text-align:center">Syncing with Angel One...</td></tr>`;
    try {
        const res = await fetch(`${state.backendUrl}/api/portfolio`);
        if(!res.ok) throw new Error("Backend error");
        
        const data = await res.json();
        state.positions = data.positions || [];
        renderUI();
    } catch(e) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--red)">Failed to load data. Is the Python server running?</td></tr>`;
    }
}

// 2. Render UI
function renderUI() {
    let totalPnl = 0, totalInv = 0;
    let html = '';

    state.positions.forEach(p => {
        totalPnl += p["P&L"];
        totalInv += p.Invested;
        
        const pnlClass = p["P&L"] > 0 ? 'positive' : p["P&L"] < 0 ? 'negative' : '';
        const pnlSign = p["P&L"] > 0 ? '+' : '';

        html += `<tr>
            <td style="font-weight:600;color:var(--white)">${p.Symbol}</td>
            <td><span class="btn-sec" style="padding:2px 6px;font-size:10px">${p.Segment}</span></td>
            <td>${p.Direction}</td>
            <td>${p.Qty}</td>
            <td>${fmtDec(p["Avg Price"])}</td>
            <td style="color:var(--white)">${fmtDec(p.CMP)}</td>
            <td class="${pnlClass}">${pnlSign}${fmtMoney(p["P&L"])}</td>
            <td class="${pnlClass}">${pnlSign}${fmtDec(p["ROI %"])}%</td>
        </tr>`;
    });

    if(state.positions.length === 0) html = `<tr><td colspan="8" style="text-align:center">No active positions.</td></tr>`;

    document.getElementById('tableBody').innerHTML = html;
    
    const pnlEl = document.getElementById('valPnl');
    pnlEl.innerText = (totalPnl>0?'+':'') + fmtMoney(totalPnl);
    pnlEl.className = 'metric-val ' + (totalPnl > 0 ? 'positive' : totalPnl < 0 ? 'negative' : '');
    
    document.getElementById('valInv').innerText = fmtMoney(totalInv);
    document.getElementById('valPos').innerText = state.positions.length;
}

// 3. Gemini AI Chat Integration
function toggleChat() {
    const p = document.getElementById('chatPanel');
    p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
}

function appendMsg(role, text) {
    const box = document.getElementById('chatBody');
    box.innerHTML += `<div class="chat-msg ${role}">${text}</div>`;
    box.scrollTop = box.scrollHeight;
}

async function sendChat() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if(!text) return;

    if(!state.apiKey) {
        alert("Please set your Gemini API Key in Settings first.");
        return;
    }

    appendMsg('user', text);
    input.value = '';
    
    // Save to history
    state.chatHistory.push({ role: "user", parts: [{ text: text }] });

    // Build Context
    const sysPrompt = `You are a pro trading assistant. Here is the user's current live portfolio JSON: ${JSON.stringify(state.positions)}. Answer questions accurately based only on this data. Be concise.`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                systemInstruction: { parts: [{ text: sysPrompt }] },
                contents: state.chatHistory.slice(-10) // Send last 10 messages for memory
            })
        });

        const data = await res.json();
        
        if (data.error) {
            appendMsg('bot', "‚ùå Error: " + data.error.message);
        } else if (data.candidates && data.candidates[0].content) {
            const reply = data.candidates[0].content.parts[0].text;
            appendMsg('bot', reply);
            state.chatHistory.push({ role: "model", parts: [{ text: reply }] });
        }
    } catch(e) {
        appendMsg('bot', "‚ùå Network error communicating with Gemini.");
    }
}

// Auto-load on open
if(state.backendUrl) fetchPortfolio();
</script>
</body>
</html>
