<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Console</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e14;--bg2:#111621;--bg3:#1a202c;--border:#1e2533;--text:#cbd5e0;--text2:#4a5568;--text3:#718096;--white:#e2e8f0;--blue:#63b3ed;--green:#48bb78;--red:#fc8181;--orange:#ed8936;--blue2:#2b6cb0}
body{font-family:'DM Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom: 80px;}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#2d3748;border-radius:3px}
button, select{cursor:pointer;font-family:'Outfit',sans-serif;transition:filter .15s}button:hover{filter:brightness(1.15)}
input, select{font-family:inherit;outline:none}

.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.logo-area{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#2b6cb0,#63b3ed);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff}
.title{font-size:20px;font-weight:800;color:var(--white);letter-spacing:2px;font-family:'Outfit',sans-serif}
.controls{display:flex;gap:10px;align-items:center}

.btn-pri{padding:8px 16px;background:linear-gradient(135deg,#2b6cb0,#3182ce);border:none;color:#fff;border-radius:6px;font-size:13px;font-weight:600}
.btn-sec{padding:8px 16px;background:var(--bg2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:13px;font-weight:600}
.btn-sec.active{background:var(--blue2);color:white;border-color:var(--blue2)}

.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:24px}
.metric-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:20px}
.metric-title{font-family:'Outfit',sans-serif;font-size:13px;color:var(--text3);margin-bottom:8px}
.metric-val{font-size:24px;font-weight:500;color:var(--white)}

.table-container{background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow-x:auto}
table{width:100%;border-collapse:collapse;text-align:left}
th{font-family:'Outfit',sans-serif;font-size:12px;color:var(--text3);font-weight:600;padding:16px;border-bottom:1px solid var(--border);background:var(--bg3);cursor:pointer;user-select:none;}
th:hover{color:var(--white)}
td{padding:16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text)}
.positive{color:var(--green);font-weight:500}
.negative{color:var(--red);font-weight:500}

.tab-container{display:flex;gap:10px;margin-bottom:16px}
#settingsPanel{display:none;background:var(--bg2);padding:16px;border-radius:8px;border:1px solid var(--border);margin-bottom:24px;gap:12px;align-items:flex-end}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo">‚ö°</div>
            <div class="title">TRADE CONSOLE</div>
        </div>
        <div class="controls">
            <select id="brokerFilter" class="btn-sec" onchange="renderUI()">
                <option value="ALL">All Brokers</option>
            </select>
            <select id="segFilter" class="btn-sec" onchange="renderUI()">
                <option value="ALL">All Segments</option>
                <option value="EQ">Equity</option>
                <option value="F&O">F&O</option>
                <option value="MCX">Commodity</option>
            </select>

            <button class="btn-sec" style="color:var(--red);border-color:var(--red)" onclick="clearLedger()">üóëÔ∏è Clear Ledger</button>
            <input type="file" id="csvUpload" multiple accept=".csv" style="display:none" onchange="handleFileUpload(event)">
            <button class="btn-sec" onclick="document.getElementById('csvUpload').click()">üìÅ Upload CSV</button>
            <button class="btn-sec" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <button class="btn-pri" onclick="fetchPortfolio()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="settingsPanel">
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3)">Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="AIzaSy..." style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <div style="flex:1">
            <label style="font-size:11px;color:var(--text3)">Backend URL</label>
            <input type="text" id="backendUrl" placeholder="https://..." style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);color:white;border-radius:6px;margin-top:4px">
        </div>
        <button class="btn-pri" onclick="saveSettings()">Save</button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title" id="lblPnl">NET P&L</div>
            <div class="metric-val" id="valPnl">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title" id="lblInv">INVESTED CAPITAL</div>
            <div class="metric-val" id="valInv">‚Çπ0</div>
        </div>
        <div class="metric-card">
            <div class="metric-title" id="lblPos">TRADES / POSITIONS</div>
            <div class="metric-val" id="valPos">0</div>
        </div>
    </div>

    <div class="tab-container">
        <button id="tab-active" class="btn-sec active" onclick="setTab('active')">ACTIVE POSITIONS</button>
        <button id="tab-closed" class="btn-sec" onclick="setTab('closed')">CLOSED HISTORY</button>
    </div>

    <div class="table-container">
        <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody">
                <tr><td colspan="9" style="text-align:center">No data loaded.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let state = {
    open: [],
    closed: [],
    currentTab: 'active',
    sortCol: 'Symbol',
    sortAsc: true,
    apiKey: localStorage.getItem('tc_gemini_key') || '',
    backendUrl: localStorage.getItem('tc_backend_url') || 'http://localhost:8000'
};

document.getElementById('geminiKey').value = state.apiKey;
document.getElementById('backendUrl').value = state.backendUrl;

function toggleSettings() {
    const p = document.getElementById('settingsPanel');
    p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
}

function saveSettings() {
    state.apiKey = document.getElementById('geminiKey').value;
    state.backendUrl = document.getElementById('backendUrl').value;
    localStorage.setItem('tc_gemini_key', state.apiKey);
    localStorage.setItem('tc_backend_url', state.backendUrl);
    toggleSettings();
}

function setTab(tab) {
